# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Focus Journey is a focus timer app where each session reveals a piece of a procedurally-generated story told through illustrated isometric 3D scenes. Users set daily focus goals, complete timed sessions, and watch puzzle pieces fade away to reveal scenes with narrative text generated by Claude API.

## Commands

```bash
npm run dev          # Start development server (http://localhost:5173)
npm run build        # Production build
npm run lint         # Run ESLint
npm run preview      # Preview production build
npm run test:e2e     # Run Playwright e2e tests
npm run test:e2e:ui  # Playwright tests with interactive UI
```

## Tech Stack

- **Frontend:** React 19 + Vite
- **3D Rendering:** React Three Fiber (R3F) + Drei
- **State:** Zustand (with localStorage persistence planned)
- **Styling:** Tailwind CSS v4 (configured via @tailwindcss/vite plugin)
- **Story Generation:** Anthropic Claude API via Vercel serverless proxy
- **Hosting:** Vercel

## Architecture

### Screen Flow
`Welcome → SessionSetup → Focus (with timer + 3D scene) → Summary`

The app uses a single Zustand store (`src/stores/focusStore.js`) that manages:
- Current screen routing via `currentScreen` state
- Session configuration (duration, theme, goal)
- Timer state (remaining, total, isRunning, isPaused)
- Scene state (sprites revealed)
- Story fragments from LLM

### Key Patterns

**Screen Routing:** No router library. `App.jsx` conditionally renders screens based on `currentScreen` from the store.

**Timer Logic:** Timer stores start time and calculates elapsed on each tick. This allows the timer to work correctly when the tab is backgrounded—on return, it recalculates from the stored start time.

**3D Scene:** `SceneCanvas` wraps R3F Canvas. Uses OrbitControls (restricted) with an isometric-style camera. Sprites use Billboard components for 2D-on-3D effect.

**2D Landscape Overlay:** `LandscapeOverlay` renders 2D landscapes with positioned sprites. Uses `useLandscapeTransform` hook to convert original image coordinates to screen coordinates, handling object-contain letterboxing. Sprites are placed within a boundary polygon using `boundaryUtils.js`.

### Serverless API

`api/generate-story.js` proxies requests to Claude API to keep the API key server-side. Expects POST with `{ prompt, theme, previousFragments }`.

## Keyboard Shortcuts

| Screen | Key | Action |
|--------|-----|--------|
| Welcome | Enter | Start setup |
| Setup | Enter | Start session |
| Setup | ↑/↓ | Adjust duration ±1 min |
| Setup | 0-9 | Type duration directly |
| Focus | Enter | Pause/Resume timer |
| Focus | R | Give up session |
| Summary | Enter | Start new session |

## Custom Theme Colors

Defined in `src/index.css` using Tailwind v4's `@theme` directive:
- `forest-*` (greens: 500-900)
- `teal-*` (400-600)
- `amber-*` (400-500)
- `stone-*` (50-900)

Use as `bg-forest-800`, `text-teal-500`, etc.

## Project Structure

```
src/
├── components/
│   ├── ui/        # CircularTimer, DurationPreviewTimer, TimerDisplay
│   ├── screens/   # WelcomeScreen, SessionSetupScreen, FocusScreen, SummaryScreen
│   └── scene/     # SceneCanvas, LandscapeOverlay, LandscapeReveal, JigsawOverlay, JigsawPiece, Sprite2D, DebugOverlay
├── hooks/         # useLandscapeTransform, useJigsawPuzzle
├── stores/        # focusStore.js (Zustand)
├── lib/
│   ├── story/     # prompts.js (LLM prompt templates)
│   ├── scene/     # landscapeConfig.js, boundaryUtils.js, sprites.js
│   ├── puzzle/    # generator.js (puzzle piece generation)
│   └── timer/     # calculator.js (time utilities)

public/assets/     # Landscape and sprite images
api/               # Vercel serverless functions
e2e/               # Playwright e2e tests
```

## Design Specs

See `docs/focus-journey-project-outline.md` for:
- Complete screen-by-screen specifications
- Data models (Session, SceneData, Theme, PuzzlePiece)
- Story generation prompt templates
- Scene composition rules
- Implementation phases

See `docs/CTO_instructions.md` for workflow and code review expectations.
See `docs/focus-journey-project-outline.md` for full project scope and technical details
